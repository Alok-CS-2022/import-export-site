<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Management - Import From Nepal Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        .char-count-ok { color: #4b5563; } /* gray-600 */
        .char-count-warning { color: #f97316; } /* orange-500 */
        .char-count-danger { color: #ef4444; } /* red-500 */
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-amber-50 via-orange-50 to-red-50 overflow-hidden">
    <!-- Floating Orbs -->
    <div class="absolute top-0 left-0 w-96 h-96 bg-amber-400 rounded-full mix-blend-multiply filter blur-3xl opacity-20" style="animation: float 10s ease-in-out infinite;"></div>
    <div class="absolute top-0 right-0 w-96 h-96 bg-orange-400 rounded-full mix-blend-multiply filter blur-3xl opacity-20" style="animation: float 12s ease-in-out infinite 2s;"></div>
    <div class="absolute bottom-0 left-1/4 w-96 h-96 bg-red-400 rounded-full mix-blend-multiply filter blur-3xl opacity-20" style="animation: float 14s ease-in-out infinite 4s;"></div>

    <div id="alertBox" class="hidden fixed top-5 right-5 z-50"></div>

    <div class="max-w-6xl mx-auto px-4 py-8 relative z-10">
        <!-- Header Card -->
        <header
            class="mb-8 p-6 bg-white/95 backdrop-blur-20 rounded-3xl shadow-2xl border border-amber-100 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <span class="text-3xl">üèîÔ∏è</span>
                <h1 class="text-3xl font-light text-gray-800">
                    Content Management
                    <span class="italic text-amber-800 font-normal">System</span>
                </h1>
            </div>
            <div class="flex items-center gap-4">
                <span class="bg-amber-100 text-amber-800 text-xs font-semibold px-3 py-1 rounded-full">Admin</span>
                <button onclick="logout()" class="text-sm text-gray-600 hover:text-amber-800 transition">Logout</button>
            </div>
        </header>

        <!-- Main Form -->
        <form id="content-form" class="glass-card p-8 rounded-3xl shadow-2xl space-y-12 border border-white/90">

            <!-- Section 1: Hero Content -->
            <div class="pb-8 border-b border-amber-200/60">
                <h2 class="text-2xl font-light text-gray-800 mb-6 flex items-center gap-3"><span class="text-xl">‚ú®</span> Hero Section</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8">
                    <div class="md:col-span-2">
                        <label for="hero_title" class="block text-sm font-medium text-gray-700 mb-2">Hero Title</label>
                        <input type="text" id="hero_title" required maxlength="200" placeholder="Handcrafted in the Himalayas" class="w-full px-4 py-3 bg-white/80 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-100 outline-none transition-all duration-300">
                        <p class="text-xs mt-2 text-right"><span id="hero_title_count" class="char-count-ok">0 / 200</span></p>
                    </div>
                    <div class="md:col-span-2">
                        <label for="hero_subtitle" class="block text-sm font-medium text-gray-700 mb-2">Hero Subtitle</label>
                        <textarea id="hero_subtitle" required maxlength="500" rows="3" class="w-full px-4 py-3 bg-white/80 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-100 outline-none transition-all duration-300"></textarea>
                        <p class="text-xs mt-2 text-right"><span id="hero_subtitle_count" class="char-count-ok">0 / 500</span></p>
                    </div>
                    <div>
                        <label for="hero_cta_text" class="block text-sm font-medium text-gray-700 mb-2">CTA Button Text</label>
                        <input type="text" id="hero_cta_text" required maxlength="50" class="w-full px-4 py-3 bg-white/80 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-100 outline-none transition-all duration-300">
                    </div>
                    <div>
                        <label for="hero_cta_link" class="block text-sm font-medium text-gray-700 mb-2">CTA Button Link</label>
                        <input type="url" id="hero_cta_link" required class="w-full px-4 py-3 bg-white/80 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-100 outline-none transition-all duration-300">
                    </div>
                </div>
            </div>

            <!-- Section 2: Testimonials -->
            <div>
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-light text-gray-800 flex items-center gap-3"><span class="text-xl">üí¨</span> Testimonials</h2>
                    <button type="button" onclick="addTestimonial()" class="bg-gradient-to-r from-amber-700 to-amber-800 text-white font-semibold px-6 py-2 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-0.5 transform transition-all duration-300">Add Testimonial</button>
                </div>
                <div id="testimonialsContainer" class="space-y-6"></div>
                <p id="noTestimonials" class="hidden text-center text-gray-400 py-8">No testimonials yet. Click Add Testimonial to begin.</p>
            </div>

            <!-- Section 3: Social Media Links -->
            <div class="pb-8 border-b border-amber-200/60">
                <h2 class="text-2xl font-light text-gray-800 mb-6 flex items-center gap-3"><span class="text-xl">üåê</span> Social Media Links</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="social_facebook" class="block text-sm font-medium text-gray-700 mb-2">Facebook URL</label>
                        <input type="url" id="social_facebook" placeholder="https://facebook.com/yourpage" class="w-full px-4 py-3 bg-white/80 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-100 outline-none transition-all duration-300">
                    </div>
                    <div>
                        <label for="social_twitter" class="block text-sm font-medium text-gray-700 mb-2">Twitter URL</label>
                        <input type="url" id="social_twitter" placeholder="https://twitter.com/yourhandle" class="w-full px-4 py-3 bg-white/80 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-100 outline-none transition-all duration-300">
                    </div>
                    <div>
                        <label for="social_instagram" class="block text-sm font-medium text-gray-700 mb-2">Instagram URL</label>
                        <input type="url" id="social_instagram" placeholder="https://instagram.com/yourhandle" class="w-full px-4 py-3 bg-white/80 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-100 outline-none transition-all duration-300">
                    </div>
                    <div>
                        <label for="social_linkedin" class="block text-sm font-medium text-gray-700 mb-2">LinkedIn URL</label>
                        <input type="url" id="social_linkedin" placeholder="https://linkedin.com/in/yourprofile" class="w-full px-4 py-3 bg-white/80 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-100 outline-none transition-all duration-300">
                    </div>
                </div>
            </div>

            <!-- Section 4: SEO Settings -->
            <div>
                <h2 class="text-2xl font-light text-gray-800 mb-6 flex items-center gap-3"><span class="text-xl">üîç</span> SEO Settings</h2>
                <div class="space-y-6">
                    <div>
                        <label for="seo_title" class="block text-sm font-medium text-gray-700 mb-2">Page Title</label>
                        <input type="text" id="seo_title" required maxlength="60" class="w-full px-4 py-3 bg-white/80 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-100 outline-none transition-all duration-300">
                        <p class="text-xs mt-2">Appears in the browser tab and search results. (<span id="seo_title_count" class="char-count-ok">0 / 60</span>)</p>
                    </div>
                    <div>
                        <label for="seo_description" class="block text-sm font-medium text-gray-700 mb-2">Meta Description</label>
                        <textarea id="seo_description" required maxlength="160" rows="3" class="w-full px-4 py-3 bg-white/80 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-100 outline-none transition-all duration-300"></textarea>
                        <p class="text-xs mt-2">Appears in search results. (<span id="seo_description_count" class="char-count-ok">0 / 160</span>)</p>
                    </div>
                    <div>
                        <label for="seo_keywords" class="block text-sm font-medium text-gray-700 mb-2">Meta Keywords</label>
                        <input type="text" id="seo_keywords" maxlength="500" class="w-full px-4 py-3 bg-white/80 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:ring-4 focus:ring-amber-100 outline-none transition-all duration-300">
                        <p class="text-xs mt-2">Optional, comma-separated. (<span id="seo_keywords_count" class="char-count-ok">0 / 500</span>)</p>
                    </div>
                </div>
            </div>

            <!-- Submit Section -->
            <div class="flex items-center gap-4 pt-8 mt-8 border-t border-amber-200/60">
                <button type="submit" id="submitBtn" class="flex-1 flex items-center justify-center gap-3 bg-gradient-to-r from-amber-700 to-amber-800 text-white font-bold rounded-xl px-8 py-4 transition-all duration-300 hover:shadow-2xl hover:-translate-y-1 disabled:opacity-70 disabled:cursor-not-allowed">
                    <span id="submitBtnText">
                        <span class="flex items-center gap-3">üíæ Save All Changes</span>
                    </span>
                </button>
                <button type="button" onclick="previewChanges()" class="flex items-center justify-center gap-2 bg-white border-2 border-amber-200 text-amber-900 font-bold rounded-xl px-8 py-4 transition-all duration-300 hover:shadow-xl hover:-translate-y-0.5">
                    üëÅÔ∏è Preview
                </button>
            </div>
        </form>
    </div>

    <script>
        // --- CORE APPLICATION LOGIC ---

        // 1. GLOBAL STATE
        let testimonials = [];
        let currentContent = {};
        let isSubmitting = false;

        // 2. HELPER FUNCTIONS
        const getValue = (id) => document.getElementById(id)?.value || '';
        const setValue = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.value = value || '';
        };

        // 3. PAGE INITIALIZATION
        async function init() {
            // In a real app, a loading overlay would be shown here
            await checkAuth();
            await loadContent();
            setupEventListeners();
            initCharCounters();
        }

        // 4. AUTHENTICATION
        async function checkAuth() {
            // In a real implementation, you'd get this from a secure cookie or local storage
            const token = localStorage.getItem('supabase.auth.token'); // As specified
            if (!token) {
                window.location.href = '/admin/login.html';
                return;
            }
            // Optional: Validate token with a lightweight API endpoint
        }

        function logout() {
            localStorage.removeItem('supabase.auth.token');
            window.location.href = '/admin/login.html';
        }

        // 5. API INTERACTIONS
        async function loadContent() {
            const token = localStorage.getItem('supabase.auth.token');
            try {
                // In a real app, you would show a full-page loader here
                const response = await fetch('/api/admin/content', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        logout();
                    }
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const result = await response.json();
                currentContent = result.data;
                populateForm(currentContent);

            } catch (error) {
                showAlert('Failed to load page content: ' + error.message, 'error');
            } finally {
                // Hide full-page loader
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();
            if (isSubmitting) return;
            isSubmitting = true;

            const btn = document.getElementById('submitBtn');
            const btnText = document.getElementById('submitBtnText');

            btn.disabled = true;
            btnText.innerHTML = `<div class="w-6 h-6 border-2 border-white border-t-transparent rounded-full spinner mx-auto"></div>`;

            try {
                const data = collectFormData();
                const token = localStorage.getItem('supabase.auth.token');

                const response = await fetch('/api/admin/content', {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Save failed');

                showAlert('Content saved successfully!', 'success');
                currentContent = result.data; // Update local state with saved data
                populateForm(currentContent); // Re-populate to ensure consistency

            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            } finally {
                isSubmitting = false;
                btn.disabled = false;
                btnText.innerHTML = `<span class="flex items-center gap-3">üíæ Save All Changes</span>`;
            }
        }

        // 6. FORM & UI MANAGEMENT
        function populateForm(data) {
            if (!data) return;
            // Hero
            setValue('hero_title', data.hero_title);
            setValue('hero_subtitle', data.hero_subtitle);
            setValue('hero_cta_text', data.hero_cta_text);
            setValue('hero_cta_link', data.hero_cta_link);
            // Social
            setValue('social_facebook', data.social_links?.facebook);
            setValue('social_twitter', data.social_links?.twitter);
            setValue('social_instagram', data.social_links?.instagram);
            setValue('social_linkedin', data.social_links?.linkedin);
            // SEO
            setValue('seo_title', data.seo_title);
            setValue('seo_description', data.seo_description);
            setValue('seo_keywords', data.seo_keywords);
            
            // Testimonials
            testimonials = data.testimonials || [];
            renderTestimonials();
            
            // Update all counters
            initCharCounters();
        }

        function collectFormData() {
            // Testimonials are collected from the DOM to ensure a single source of truth
            const testimonialInputs = [];
            document.querySelectorAll('.testimonial-card').forEach((card, i) => {
                testimonialInputs.push({
                    name: card.querySelector('.testimonial-name').value,
                    role: card.querySelector('.testimonial-role').value,
                    content: card.querySelector('.testimonial-content').value,
                    rating: parseInt(card.querySelector('.testimonial-rating').value, 10) || 5
                });
            });

            return {
                hero_title: getValue('hero_title'),
                hero_subtitle: getValue('hero_subtitle'),
                hero_cta_text: getValue('hero_cta_text'),
                hero_cta_link: getValue('hero_cta_link'),
                testimonials: testimonialInputs,
                social_links: {
                    facebook: getValue('social_facebook'),
                    twitter: getValue('social_twitter'),
                    instagram: getValue('social_instagram'),
                    linkedin: getValue('social_linkedin')
                },
                seo_title: getValue('seo_title'),
                seo_description: getValue('seo_description'),
                seo_keywords: getValue('seo_keywords')
            };
        }

        function previewChanges() {
            // In a real scenario, this might save to a 'draft' and open a preview URL
            showAlert('Opening site homepage in new tab.', 'success');
            window.open('/', '_blank');
        }

        // 7. EVENT LISTENERS & INITIALIZERS
        function setupEventListeners() {
            document.getElementById('content-form').addEventListener('submit', handleSubmit);
        }

        function initCharCounters() {
            updateCharCount('hero_title');
            updateCharCount('hero_subtitle');
            updateCharCount('seo_title');
            updateCharCount('seo_description');
            updateCharCount('seo_keywords');
        }

        function updateCharCount(fieldId) {
            const input = document.getElementById(fieldId);
            if (!input) return;
            const counterSpan = document.getElementById(fieldId + '_count');
            if(!counterSpan) return;

            const maxLength = input.maxLength;
            if (maxLength < 0) return; // Don't run on fields without maxlength
            
            const current = input.value.length;
            counterSpan.textContent = `${current} / ${maxLength}`;
            const ratio = current / maxLength;

            counterSpan.className = 'char-count-ok';
            if (ratio > 0.95) {
                counterSpan.className = 'char-count-danger';
            } else if (ratio > 0.8) {
                counterSpan.className = 'char-count-warning';
            }
        }
        
        // 8. DYNAMIC UI (TESTIMONIALS & ALERTS)
        function addTestimonial() {
            testimonials.push({ name: '', role: '', content: '', rating: 5 });
            renderTestimonials();
        }

        function removeTestimonial(index) {
            if (confirm('Are you sure you want to remove this testimonial?')) {
                testimonials.splice(index, 1);
                renderTestimonials();
            }
        }

        function renderTestimonials() {
            const container = document.getElementById('testimonialsContainer');
            const empty = document.getElementById('noTestimonials');
            if (!container || !empty) return;

            if (testimonials.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            container.innerHTML = testimonials.map((t, i) => `
                <div class="testimonial-card bg-amber-50/70 rounded-2xl p-6 space-y-4 border border-amber-100/80">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-lg text-amber-900">Testimonial #${i + 1}</h3>
                        <button type="button" onclick="removeTestimonial(${i})" class="bg-red-100 text-red-700 px-3 py-1 rounded-lg text-sm font-semibold hover:bg-red-200 transition">Remove</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" placeholder="Name" value="${t.name || ''}" class="testimonial-name w-full px-4 py-3 bg-white/80 border-2 border-gray-200 rounded-xl outline-none" data-index="${i}" required>
                        <input type="text" placeholder="Role" value="${t.role || ''}" class="testimonial-role w-full px-4 py-3 bg-white/80 border-2 border-gray-200 rounded-xl outline-none" data-index="${i}" required>
                        <textarea placeholder="Content" class="col-span-2 testimonial-content w-full px-4 py-3 bg-white/80 border-2 border-gray-200 rounded-xl outline-none" data-index="${i}" rows="3" required>${t.content || ''}</textarea>
                        <input type="number" placeholder="Rating (1-5)" min="1" max="5" value="${t.rating || 5}" class="testimonial-rating w-full px-4 py-3 bg-white/80 border-2 border-gray-200 rounded-xl outline-none" data-index="${i}" required>
                    </div>
                </div>
            `).join('');
        }
        
        function showAlert(message, type) {
            const alert = document.getElementById('alertBox');
            if(!alert) return;

            alert.className = `glass-card rounded-2xl p-4 mb-6 border-2 animate-slide-in ${
                type === 'success' ? 'bg-green-50/80 border-green-500 text-green-900' : 'bg-red-50/80 border-red-500 text-red-900'
            }`;
            alert.textContent = message;
            alert.classList.remove('hidden');

            setTimeout(() => {
                alert.classList.add('hidden');
            }, 5000);
        }

        // 9. INITIALIZE ON LOAD
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>