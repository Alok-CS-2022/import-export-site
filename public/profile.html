<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Import From Nepal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

    <!-- Nav -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="index.html" class="text-xl font-bold text-amber-700">Import From Nepal</a>
                <button onclick="handleLogout()" class="text-sm text-red-600 hover:text-red-800 font-medium">Sign
                    Out</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

        <div class="flex flex-col md:flex-row gap-8">
            <!-- Sidebar -->
            <aside class="w-full md:w-64">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center text-amber-700 font-bold text-xl"
                            id="user-avatar">U</div>
                        <div>
                            <p class="font-semibold text-gray-900" id="user-name">Loading...</p>
                            <p class="text-xs text-gray-500" id="user-email">...</p>
                        </div>
                    </div>
                    <nav class="space-y-1">
                        <a href="#" class="block px-4 py-2 bg-amber-50 text-amber-700 rounded-lg font-medium text-sm">My
                            Orders</a>
                        <!-- Future: Address Book, Settings -->
                    </nav>
                </div>
            </aside>

            <!-- Content -->
            <div class="flex-1">
                <h1 class="text-2xl font-bold text-gray-900 mb-6">Order History</h1>

                <!-- Orders List -->
                <div id="orders-container" class="space-y-4">
                    <div class="text-center py-12">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-amber-700 mx-auto"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Logic -->
    <script type="module">
        import { supabase } from './lib/supabase.js';

        let currentUser = null;

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = session.user;
            setupUserProfile();
            fetchOrders();
        });

        function setupUserProfile() {
            const email = currentUser.email;
            const name = email.split('@')[0];

            document.getElementById('user-name').textContent = name;
            document.getElementById('user-email').textContent = email;
            document.getElementById('user-avatar').textContent = name.charAt(0).toUpperCase();
        }

        async function fetchOrders() {
            const container = document.getElementById('orders-container');
            
            // More robust session check
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            if (sessionError || !session) {
                container.innerHTML = `<div class="bg-red-50 text-red-600 p-4 rounded-lg">Authentication error. Please log in again.</div>`;
                return;
            }

            try {
                // Query Supabase directly instead of using API endpoint
                const { data: orders, error: ordersError } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .order('created_at', { ascending: false });

                // Check for Supabase errors
                if (ordersError) {
                    console.error('Supabase error:', ordersError);
                    container.innerHTML = `
                        <div class="bg-red-50 text-red-600 p-4 rounded-lg">
                            <p class="font-semibold">Error loading orders</p>
                            <p class="text-sm mt-1">${ordersError.message || 'Unable to fetch your orders. Please try again later.'}</p>
                        </div>
                    `;
                    return;
                }

                // Handle empty orders
                if (!orders || orders.length === 0) {
                    container.innerHTML = `
                        <div class="bg-white rounded-xl shadow-sm p-8 text-center text-gray-500">
                            <p class="text-lg">No orders yet.</p>
                            <a href="index.html#products" class="text-amber-700 hover:underline mt-2 inline-block">Start Shopping</a>
                        </div>
                    `;
                    return;
                }

                // Render orders
                container.innerHTML = orders.map(order => `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 hover:shadow-md transition">
                        <div class="px-6 py-4 border-b flex justify-between items-center bg-gray-50">
                            <div>
                                <span class="text-xs font-semibold uppercase tracking-wider text-gray-500">Order ID</span>
                                <p class="font-mono text-sm font-medium text-gray-900">#${order.id ? order.id.toString().slice(0, 8) : 'N/A'}</p>
                            </div>
                            <div class="text-right">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    ${order.status || 'Pending'}
                                </span>
                                <p class="text-xs text-gray-500 mt-1">${order.created_at ? new Date(order.created_at).toLocaleDateString() : 'N/A'}</p>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-medium text-gray-900">${order.product_name || order.customer_name || 'Order Item'}</h4>
                                    <p class="text-sm text-gray-600 mt-1">Total: ${order.total_amount ? '$' + order.total_amount : 'TBD'}</p>
                                </div>
                                <div>
                                    <!-- Action buttons could go here (e.g. View Invoice) -->
                                </div>
                            </div>
                            ${(() => {
                        try {
                            if (!order.items && !order.message) return '';
                            const items = order.items ? (typeof order.items === 'string' ? JSON.parse(order.items) : order.items) : null;
                            const firstItem = items ? (Array.isArray(items) ? items[0] : items) : null;
                            const message = firstItem?.message || order.message || 'No specific notes.';
                            return `
                                    <div class="mt-4 pt-4 border-t border-gray-100">
                                        <p class="text-xs text-gray-500 italic">${message}</p>
                                    </div>
                                    `;
                        } catch (e) {
                            console.error('Error parsing order items:', e);
                            return '';
                        }
                    })()}
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                console.error('Unexpected error:', err);
                container.innerHTML = `
                    <div class="bg-red-50 text-red-600 p-4 rounded-lg">
                        <p class="font-semibold">Unexpected error</p>
                        <p class="text-sm mt-1">${err.message || 'Something went wrong. Please refresh the page.'}</p>
                    </div>
                `;
            }
        }

        window.handleLogout = async () => {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        };
    </script>
</body>

</html>